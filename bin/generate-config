#!/usr/bin/env ruby

require 'rubygems'
require 'mixlib/cli'
require 'mixlib/shellout'
require 'json'
require 'uri'

class GenerateConfig
  include Mixlib::CLI

  banner "
    If you are having to edit the json attributes file then I'm doing it wrong.
    Please submit an issue: https://github.com/opscode/qa-chef-server-cluster/issues
    "

  option :chef_server_core_install,
    :long => '--chef-server-core-install SERVER INSTALL VERSION',
    :default => nil

  option :chef_server_upgrade,
    :long => '--chef-server-core-upgrade SERVER UPGRADE VERSION',
    :default => nil

  option :opscode_manage_install,
    :long => '--opscode-manage-install MANAGE INSTALL VERSION',
    :default => nil

  option :opscode_manage_upgrade,
    :long => '--opscode-manage-upgrade-version MANAGE UPGRADE VERSION',
    :default => nil

  option :chef_ha_install,
    :long => '--chef-ha-install CHEF HA INSTALL VERSION',
    :default => nil

  option :chef_ha_upgrade,
    :long => '--chef-ha-upgrade CHEF HA UPGRADE VERSION',
    :default => nil

  option :enable_upgrade,
    :short => '-u',
    :long => '--enable-upgrade',
    :description => 'enables the upgrade process',
    :boolean => true

  option :disable_auto_destroy,
    :long => '--disable-auto-destroy',
    :description => 'disables auto destroy of clusters after tests',
    :boolean => true

  option :skip_pedant,
    :long => '--skip-pedant',
    :description => "skip 'chef-server-ctl test' execution",
    :boolean => true

  option :topology,
    :short => '-t',
    :long => '--topology TOPOLOGY',
    :description => 'chef server topology'

  option :attributes_file,
    :short => '-j',
    :long => '--json-attributes JSON ATTRIBUTES',
    :description => 'output path for attributes file',
    :default => 'attributes.json'

  option :overwrite_attributes_file,
    :short => '-f',
    :description => 'overwrite existing attributes file',
    :boolean => true

  option :run_recipe,
    :short => '-r',
    :long => '--run-recipe RUN RECIPE',
    :description => 'run chef-client with run recipe'

  # Placeholder
  # option :chef_repo_path,
  #   :long => '--chef-repo-path',
  #   :description => "set the chef_repo_path. create path if it doesn't exist."

  option :platform,
    :short => '-p',
    :long => '--platform PLATFORM-VERSION',
    :description => 'Platform and version',
    :default => 'ubuntu-14.04'

  option :help,
    :short => "-h",
    :long => "--help",
    :description => "Show this message",
    :on => :tail,
    :boolean => true,
    :show_options => true,
    :exit => 0

    # TODO add node.default['qa-chef-server-cluster']['chef-provisioner-key-name'] override
    # or perhaps a default insecure key

    # TODO :bootstrap_options => { :key_name override
end


cli = GenerateConfig.new
cli.parse_options

IMAGE_MAP = {
  'ubuntu-10.04' => 'ami-eb5b19db', # ebs-io1; ebs-ssd not mounting the root fs
  'ubuntu-12.04' => 'ami-0f47053f', # ebs-hvm-ssd
  'ubuntu-14.04' => 'ami-3d50120d', # ebs-hvm-ssd

  # RedHat
  'el-5' => 'ami-87d948b7', # ebs-magnetic
  'el-6' => 'ami-aa8bfe9a', # ebs-magnetic
  'el-7' => 'ami-77d7a747', # ebs-hvm-magnetic
}

def ssh_user_for(image)
  case image
  when /^ubuntu/
    'ubuntu'

  when /^el/
    version = image.match(/el-(?<version>.+)/)[:version]
    raise "Unknown image #{image}!" if version.nil?

    version.to_i == 5 ? 'root' : 'ec2-user'

  else
    'ec2-user'
  end
end

attrs = {
  '_comment' => "If you are having to edit the json attributes file then I'm doing it wrong. Please submit an issue: https://github.com/opscode/qa-chef-server-cluster/issues",
  'qa-chef-server-cluster' => {
    'enable-upgrade' => cli.config[:enable_upgrade] ? true : false,
    'auto-destroy' => cli.config[:disable_auto_destroy] ? false : true,
    'run-pedant' => cli.config[:skip_pedant] ? false : true,

    'chef-server-core' => {},
    'opscode-manage' => {},
    'chef-ha' => {},

    'aws' => {
      'machine_options' => {
        'ssh_username' => ssh_user_for(cli.config[:platform]),
        'bootstrap_options' => {
          'image_id' => IMAGE_MAP[cli.config[:platform]]
        }
      }
    }
  }
}

attrs['qa-chef-server-cluster']['chef-server-core']['install'] = cli.config[:chef_server_core_install] if cli.config[:chef_server_core_install]
attrs['qa-chef-server-cluster']['chef-server-core']['upgrade'] = cli.config[:chef_server_core_upgrade] if cli.config[:chef_server_core_upgrade]
attrs['qa-chef-server-cluster']['opscode-manage']['install'] = cli.config[:opscode_manage_install] if cli.config[:opscode_manage_install]
attrs['qa-chef-server-cluster']['opscode-manage']['upgrade'] = cli.config[:opscode_manage_upgrade] if cli.config[:opscode_manage_upgrade]
attrs['qa-chef-server-cluster']['chef-ha']['install'] = cli.config[:chef_ha_install] if cli.config[:chef_ha_install]
attrs['qa-chef-server-cluster']['chef-ha']['upgrade'] = cli.config[:chef_ha_upgrade_version] if cli.config[:chef_ha_upgrade]
attrs['qa-chef-server-cluster']['topology'] = cli.config[:topology] if cli.config[:topology]

raise "#{cli.config[:attributes_file]} exists. Change file path or use -f option" if File.exist?(cli.config[:attributes_file]) and not cli.config[:overwrite_attributes_file]

open(cli.config[:attributes_file], 'w') do |f|
  f.puts JSON.pretty_generate(attrs)
end

puts "Attributes written to file #{cli.config[:attributes_file]}."

if cli.config[:run_recipe]
  system("bundle exec chef-client -z -j #{cli.config[:attributes_file]} -o qa-chef-server-cluster::#{cli.config[:run_recipe]}")
end
