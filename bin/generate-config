#!/usr/bin/env ruby

require 'rubygems'
require 'mixlib/cli'
require 'json'

class GenerateConfig
  include Mixlib::CLI

  option :server_install_version,
    :long => '--server-install-version CHEF SERVER CORE VERSION',
    :description => 'specify chef-server-core version from packagecloud chef/stable repo'

  option :manage_install_version,
    :long => '--manage-install-version OPSCODE MANAGE VERSION',
    :description => 'specify opscode-manage version from packagecloud chef/stable repo'
  option :server_install_source,
    :long => '--server-install-source CHEF SERVER CORE SOURCE',
    :description => 'specify chef-server-core url location. Ignores version options'

  option :manage_install_source,
    :long => '--manage-install-source OPSCODE MANAGE SOURCE',
    :description => 'specify opscode-manage url location. Ignores version options'

  option :server_upgrade_version,
    :long => '--server-upgrade-version CHEF SERVER CORE UPGRADE VERSION',
    :description => 'specify chef-server-core upgrade version from packagecloud chef/stable repo'

  option :manage_upgrade_version,
    :long => '--manage-upgrade-version OPSCODE MANAGE UPGRADE VERSION',
    :description => 'specify opscode-manage upgrade version from packagecloud chef/stable repo'

  option :server_upgrade_source,
    :long => '--server-upgrade-source CHEF SERVER CORE UPGRADE SOURCE',
    :description => 'specify chef-server-core upgrade url location. Ignores version options'

  option :manage_upgrade_source,
    :long => '--manage-upgrade-source OPSCODE MANAGE UPGRADE SOURCE',
    :description => 'specify opscode-manage upgrade url location. Ignores version options'

  option :enable_upgrade,
    :long => '--enable-upgrade',
    :boolean => true

  option :disable_auto_destroy,
    :long => '--disable-auto-destroy',
    :boolean => true

  option :attributes_file,
    :short => '-j',
    :long => '--json-attributes JSON ATTRIBUTES',
    :description => 'output path for attributes file',
    :default => 'attributes.json'

  option :overwrite_attributes_file,
    :short => '-f',
    :description => 'overwrite existing attributes file',
    :boolean => true

  option :help,
    :short => "-h",
    :long => "--help",
    :description => "Show this message",
    :on => :tail,
    :boolean => true,
    :show_options => true,
    :exit => 0

end

cli = GenerateConfig.new
cli.parse_options

attrs = { 'qa-chef-server-cluster' => {'chef-server-core' => {}, 'opscode-manage' => {} } }

attrs['qa-chef-server-cluster']['chef-server-core']['version'] = cli.config[:server_install_version] if cli.config[:server_install_version]
attrs['qa-chef-server-cluster']['opscode-manage']['version'] = cli.config[:manage_install_version] if cli.config[:manage_install_version]

attrs['qa-chef-server-cluster']['chef-server-core']['source'] = cli.config[:server_install_source] if cli.config[:server_install_source]
attrs['qa-chef-server-cluster']['opscode-manage']['source'] = cli.config[:manage_install_source] if cli.config[:manage_install_source]

attrs['qa-chef-server-cluster']['chef-server-core']['upgrade-version'] = cli.config[:server_upgrade_version] if cli.config[:server_upgrade_version]
attrs['qa-chef-server-cluster']['opscode-manage']['upgrade-version'] = cli.config[:manage_upgrade_version] if cli.config[:manage_upgrade_version]

attrs['qa-chef-server-cluster']['chef-server-core']['upgrade-source'] = cli.config[:server_upgrade_source] if cli.config[:server_upgrade_source]
attrs['qa-chef-server-cluster']['opscode-manage']['upgrade-source'] = cli.config[:manage_upgrade_source] if cli.config[:manage_upgrade_source]

attrs['qa-chef-server-cluster']['enable-upgrade'] = true if cli.config[:enable_upgrade]
attrs['qa-chef-server-cluster']['auto-destroy'] = false if cli.config[:disable_auto_destroy]

raise "#{cli.config[:attributes_file]} exists. Change file path or use -f option" if File.exist?(cli.config[:attributes_file]) and not cli.config[:overwrite_attributes_file]

open(cli.config[:attributes_file], 'w') do |f|
  f.puts JSON.pretty_generate(attrs)
end

puts "Attributes written to file #{cli.config[:attributes_file]}."
